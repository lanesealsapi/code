<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Open Melodies — 30 Public-Domain Tunes</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa8bf;--accent:#8b5cf6}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,#071028 0%, #07111b 100%); color:#e6eef8}
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:12px;align-items:center;margin:12px 0}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08));padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .song{display:grid;grid-template-columns:1fr 160px;gap:12px;align-items:center;padding:12px;border-radius:10px}
    .song + .song{margin-top:10px}
    .meta{display:flex;flex-direction:column}
    .meta b{font-size:14px}
    .notes{margin-top:8px;font-family:monospace;color:var(--muted);font-size:13px}
    button{background:linear-gradient(90deg,var(--accent),#6ee7b7);border:none;padding:8px 12px;border-radius:8px;color:#07111b;font-weight:600;cursor:pointer}
    .small{font-size:13px;padding:6px 8px}
    label{font-size:13px;color:var(--muted)}
    .tempo{width:160px}
    .note-bubble{display:inline-block;padding:6px 8px;margin:4px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .note-bubble.active{background:linear-gradient(90deg,var(--accent),#6ee7b7);color:#031018;font-weight:700}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    @media (max-width:760px){.song{grid-template-columns:1fr 120px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,#10202f,#18303e);display:flex;align-items:center;justify-content:center;font-weight:700;color:#9be3d7">♪</div>
      <div>
        <h1>Open Melodies — 30 Public-Domain Tunes</h1>
        <p class="lead">30 preloaded public-domain/traditional melodies. Play, loop, change tempo, watch note highlighting. Edit note arrays directly in the HTML.</p>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <label for="tempo">Tempo</label>
        <input id="tempo" type="range" min="40" max="220" value="110" class="tempo" />
        <span id="tempoVal">110 BPM</span>
        <button id="stop" class="small">Stop</button>
        <div style="margin-left:auto;color:var(--muted);font-size:13px">Synth: simple sine oscillator</div>
      </div>

      <!-- Songs list -->
      <div id="songs">
        <!-- Songs are rendered by JS -->
      </div>

      <footer>
        These melodies are traditional / public-domain. You can edit the note arrays in the HTML to change them.
      </footer>
    </div>
  </div>

  <script>
    // ---------- Utilities: note -> frequency
    function noteToFreq(note){
      if(!note) return 0;
      if(note === 'R') return 0;
      const noteRegex = /^([A-Ga-g])([#b]?)(-?\d)$/;
      const m = note.match(noteRegex);
      if(!m) return 0;
      const [, letter, accidental, octaveStr] = m;
      const octave = parseInt(octaveStr);
      const letters = {C:0,D:2,E:4,F:5,G:7,A:9,B:11};
      let semis = letters[letter.toUpperCase()];
      if(accidental === '#') semis += 1;
      if(accidental === 'b') semis -= 1;
      // MIDI note number: C0 = MIDI 12. A4 = MIDI 69 (440 Hz)
      const midi = (octave + 1) * 12 + semis;
      const freq = 440 * Math.pow(2, (midi - 69)/12);
      return freq;
    }

    // ---------- Melody definitions (30 songs: 15 folk + 15 classical/traditional)
    // Each melody: id, title, origin, notes: [['C4',1], ...]
    const melodies = [
      {id:'twinkle',title:'Twinkle Twinkle Little Star',origin:'Traditional',notes:[['C4',1],['C4',1],['G4',1],['G4',1],['A4',1],['A4',1],['G4',2],['F4',1],['F4',1],['E4',1],['E4',1],['D4',1],['D4',1],['C4',2]]},
      {id:'fur_elise',title:'Für Elise (opening)',origin:'Beethoven',notes:[['E5',0.5],['D#5',0.5],['E5',0.5],['D#5',0.5],['E5',0.5],['B4',0.5],['D5',0.5],['C5',0.5],['A4',1]]},
      {id:'greensleeves',title:'Greensleeves (opening)',origin:'Traditional',notes:[['E4',1],['D4',1],['C4',1],['D4',1],['E4',1],['E4',1],['E4',2],['D4',1],['D4',1],['D4',2],['E4',1],['G4',1],['G4',2]]},
      {id:'amazing',title:'Amazing Grace (opening)',origin:'Traditional',notes:[['E4',1],['G4',1],['E4',1],['D4',1],['C4',2],['E4',1],['G4',1],['E4',1],['D4',1],['C4',2]]},
      {id:'scarborough',title:'Scarborough Fair (opening)',origin:'Traditional',notes:[['E4',1],['D4',1],['E4',1],['D4',1],['C4',2],['E4',1],['G4',1],['A4',2]]},
      {id:'ode_to_joy',title:'Ode to Joy (opening)',origin:'Beethoven',notes:[['E4',1],['E4',1],['F4',1],['G4',1],['G4',1],['F4',1],['E4',1],['D4',1],['C4',1],['C4',1],['D4',1],['E4',1],['E4',1.5],['D4',0.5],['D4',2]]},
      {id:'silent_night',title:'Silent Night (opening)',origin:'Gruber',notes:[['G4',2],['A4',2],['G4',2],['E4',2],['G4',2],['A4',2],['G4',2],['E4',2],['D5',2],['D5',2],['B4',2],['C5',2],['A4',2]]},
      {id:'happy_bday',title:'Happy Birthday (opening)',origin:'Public domain',notes:[['C4',1],['C4',1],['D4',1],['C4',1],['F4',1],['E4',2]]},
      {id:'when_saints',title:'When the Saints',origin:'Traditional',notes:[['C4',1],['E4',1],['F4',1],['G4',1],['C5',1],['E5',1],['F5',1],['G5',2]]},
      {id:'mary_had',title:'Mary Had a Little Lamb',origin:'Traditional',notes:[['E4',1],['D4',1],['C4',1],['D4',1],['E4',1],['E4',1],['E4',2]]},
      {id:'jingle',title:'Jingle Bells (opening)',origin:'Public domain',notes:[['E4',1],['E4',1],['E4',2],['E4',1],['E4',1],['E4',2],['E4',1],['G4',1],['C4',1],['D4',1],['E4',2]]},
      {id:'yankee',title:'Yankee Doodle',origin:'Traditional',notes:[['C4',1],['E4',1],['F4',1],['G4',1],['C5',1],['E5',1],['F5',1],['G5',2]]},
      {id:'row',title:'Row Row Row Your Boat',origin:'Traditional',notes:[['C4',1],['C4',1],['C4',1],['D4',1],['E4',2]]},
      {id:'joy_world',title:'Joy to the World (opening)',origin:'Public domain',notes:[['D4',1],['C4',1],['B3',1],['A3',1],['G3',2]]},
      {id:'clementine',title:'Oh My Darling Clementine',origin:'Traditional',notes:[['C4',1],['E4',1],['F4',1],['G4',1],['E4',2]]},
      {id:'lullaby',title:'Brahms Lullaby (opening)',origin:'Brahms',notes:[['G4',2],['E4',2],['G4',2],['E4',2],['G4',1],['F#4',1],['G4',2]]},
      {id:'lochnagar',title:'Annie Laurie (opening)',origin:'Traditional',notes:[['G4',1],['A4',1],['B4',2],['A4',1],['G4',1],['E4',2]]},
      {id:'auld',title:'Auld Lang Syne (opening)',origin:'Traditional',notes:[['G4',1],['C5',1],['C5',1],['A4',1],['C5',1],['B4',2]]},
      {id:'home_range',title:'Home on the Range (opening)',origin:'Traditional',notes:[['C4',1],['E4',1],['G4',2],['A4',1],['G4',1],['E4',2]]},
      {id:'minka',title:'Minka (Russian folk)',origin:'Traditional',notes:[['E4',1],['F#4',1],['G4',2],['G4',1],['F#4',1],['E4',2]]},
      {id:'air',title:'Air (Bach) opening',origin:'Bach',notes:[['D4',1],['F#4',1],['A4',2],['G4',1],['F#4',1],['E4',2]]},
      {id:'jeannie',title:'Jeannie with the Light Brown Hair',origin:'Foster',notes:[['C4',1],['E4',1],['G4',2],['A4',1],['G4',1],['E4',2]]},
      {id:'trumpet',title:'Trumpet Voluntary (theme)',origin:'Clarke',notes:[['D4',1],['F#4',1],['A4',2],['D5',1],['C5',1],['A4',2]]},
      {id:'la_cucaracha',title:'La Cucaracha',origin:'Traditional',notes:[['G4',1],['G4',1],['G4',1],['E4',1],['C4',2]]},
      {id:'susanna',title:'Oh Susanna',origin:'Foster',notes:[['C4',1],['E4',1],['G4',1],['G4',1],['A4',1],['A4',1],['G4',2]]},
      {id:'alouette',title:'Alouette',origin:'Traditional',notes:[['G4',1],['A4',1],['B4',1],['C5',1],['B4',1],['A4',1],['G4',2]]},
      {id:'kookaburra',title:'Kookaburra',origin:'Public domain',notes:[['G4',1],['G4',1],['E4',1],['G4',1],['C5',2]]},
      {id:'frere',title:'Frère Jacques',origin:'Traditional',notes:[['C4',1],['D4',1],['E4',1],['C4',1],['C4',1],['D4',1],['E4',1],['C4',1]]},
      {id:'canonc',title:'Pachelbel Canon (motif)',origin:'Pachelbel',notes:[['D4',1],['A3',1],['B3',1],['F#4',1],['G4',1],['D4',1],['G3',1],['A3',1]]},
      {id:'barcarolle',title:'Barcarolle (opening)',origin:'Offenbach',notes:[['G4',1],['A4',1],['B4',1],['C5',1],['B4',2]]}
    ];

    // ---------- Audio context + simple synth
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    let masterGain = ctx.createGain();
    masterGain.gain.value = 0.18;
    masterGain.connect(ctx.destination);

    function playNote(freq, durationMs){
      if(freq === 0 || !isFinite(freq)) return new Promise(r => setTimeout(r,durationMs));
      return new Promise((resolve)=>{
        const osc = ctx.createOscillator();
        const env = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.value = freq;
        osc.connect(env);
        env.connect(masterGain);
        const now = ctx.currentTime;
        env.gain.cancelScheduledValues(now);
        env.gain.setValueAtTime(0, now);
        env.gain.linearRampToValueAtTime(1.0, now + 0.01);
        env.gain.linearRampToValueAtTime(0.0001, now + durationMs/1000);
        osc.start(now);
        osc.stop(now + durationMs/1000 + 0.02);
        osc.onended = () => resolve();
      });
    }

    // ---------- UI Rendering
    const songsDiv = document.getElementById('songs');
    function renderSongs(){
      songsDiv.innerHTML = '';
      melodies.forEach((m, idx)=>{
        const wrapper = document.createElement('div');
        wrapper.className = 'song';

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `<b>${m.title}</b><span style="font-size:12px;color:var(--muted)">${m.origin}</span>`;

        const notesWrap = document.createElement('div');
        notesWrap.className = 'notes';
        // create note bubbles
        m.notes.forEach((pair,i)=>{
          const [n,d] = pair;
          const span = document.createElement('span');
          span.className = 'note-bubble';
          span.dataset.song = m.id;
          span.dataset.index = i;
          span.textContent = n + (d!==1?(' ('+d+')'):'');
          notesWrap.appendChild(span);
        });

        meta.appendChild(notesWrap);
        wrapper.appendChild(meta);

        const controls = document.createElement('div');
        controls.style.display = 'flex';
        controls.style.flexDirection = 'column';
        controls.style.gap = '8px';
        const playBtn = document.createElement('button');
        playBtn.textContent = 'Play';
        playBtn.onclick = ()=> playMelody(idx);
        const loopBtn = document.createElement('button');
        loopBtn.textContent = 'Play Loop';
        loopBtn.className = 'small';
        loopBtn.onclick = ()=> playMelody(idx, {loop:true});
        const viewBtn = document.createElement('button');
        viewBtn.textContent = 'Show Notes';
        viewBtn.className = 'small';
        viewBtn.onclick = ()=> alert(m.notes.map(p=>p[0]+' ×'+p[1]).join('\n'));

        controls.appendChild(playBtn);
        controls.appendChild(loopBtn);
        controls.appendChild(viewBtn);

        wrapper.appendChild(controls);
        songsDiv.appendChild(wrapper);
      });
    }

    // ---------- Playback
    let stopRequested = false;

    function clearActiveHighlights(){
      document.querySelectorAll('.note-bubble.active').forEach(el=>el.classList.remove('active'));
    }

    async function playMelody(index, opts={}){
      stopRequested = false;
      const tempo = Number(document.getElementById('tempo').value);
      const song = melodies[index];
      const beatMs = (60/tempo)*1000;
      if(ctx.state === 'suspended') await ctx.resume();

      do{
        clearActiveHighlights();
        for(let i=0;i<song.notes.length;i++){
          if(stopRequested){ clearActiveHighlights(); return; }
          const [n,d] = song.notes[i];
          const bubble = document.querySelector(`.note-bubble[data-song="${song.id}"][data-index="${i}"]`);
          if(bubble){ clearActiveHighlights(); bubble.classList.add('active'); }
          const freq = noteToFreq(n);
          await playNote(freq, beatMs * d);
        }
      } while(opts.loop && !stopRequested);
      clearActiveHighlights();
    }

    document.getElementById('tempo').addEventListener('input', (e)=>{
      document.getElementById('tempoVal').textContent = e.target.value + ' BPM';
    });

    document.getElementById('stop').addEventListener('click', ()=>{
      stopRequested = true;
      clearActiveHighlights();
    });

    renderSongs();

    // mobile-friendly hint: resume audio on first tap anywhere
    document.body.addEventListener('click', async function initAudio(){
      if(ctx.state === 'suspended') try{ await ctx.resume(); } catch(e){}
      document.body.removeEventListener('click', initAudio);
    });
  </script>
</body>
</html>
