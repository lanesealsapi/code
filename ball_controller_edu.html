<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Voice Controlled Ball</title>
<style>
  body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #111; font-family: sans-serif; }
  canvas { display: block; }
  #startBtn { position: absolute; top: 10px; left: 10px; padding: 8px 12px; font-size: 16px; }
  #colorControl { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; align-items: center; color: #fff; }
  input[type=range] { width: 100px; }
</style>
</head>
<body>
<button id="startBtn">Start Voice Control</button>
<div id="colorControl">
  <label>Glow</label><input type="range" id="glowRange" min="0" max="50" value="20">
  <label>Hue</label><input type="range" id="hueRange" min="0" max="360" value="180">
</div>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let ball = { x: canvas.width/2, y: canvas.height/2, radius: 30, colorHue: 180, glow: 20 };

let audioContext, analyser, dataArray, source;

function drawBall(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.shadowBlur = ball.glow;
  ctx.shadowColor = `hsl(${ball.colorHue}, 100%, 50%)`;
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
  ctx.fillStyle = `hsl(${ball.colorHue}, 100%, 50%)`;
  ctx.fill();
  ctx.closePath();
  ctx.shadowBlur = 0;
}

drawBall();

function startVoiceControl(){
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    source = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 512;
    source.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    animate();
  }).catch(err => alert('Error accessing microphone: ' + err));
}

function getAverageAmplitude(array){
  let sum = 0;
  for(let i=0;i<array.length;i++) sum += array[i];
  return sum/array.length;
}

let smoothingX = 0;
let smoothingY = 0;
function animate(){
  requestAnimationFrame(animate);
  analyser.getByteFrequencyData(dataArray);

  const amplitude = getAverageAmplitude(dataArray); // 0-255

  // Weighted frequency center
  let weightedSum = 0;
  let total = 0;
  for(let i=0;i<dataArray.length;i++){
    weightedSum += i * dataArray[i];
    total += dataArray[i];
  }
  let freqPos = total ? weightedSum/total : dataArray.length/2; // avoid division by zero
  let freqNorm = freqPos / dataArray.length; // 0-1

  // Map amplitude to vertical movement (-1 to 1)
  let vMove = ((amplitude - 128)/128); // -1 to 1
  let hMove = (freqNorm - 0.5) * 2; // -1 to 1

  // smoothing for stability
  smoothingX = smoothingX*0.85 + hMove*5*0.15;
  smoothingY = smoothingY*0.85 + vMove*5*0.15;

  ball.x += smoothingX;
  ball.y -= smoothingY; // subtract to make higher amplitude move up

  // clamp
  ball.x = Math.max(ball.radius, Math.min(canvas.width-ball.radius, ball.x));
  ball.y = Math.max(ball.radius, Math.min(canvas.height-ball.radius, ball.y));

  // update color and glow from UI
  ball.colorHue = document.getElementById('hueRange').value;
  ball.glow = document.getElementById('glowRange').value;

  drawBall();
}

document.getElementById('startBtn').addEventListener('click', ()=>{
  startVoiceControl();
  document.getElementById('startBtn').style.display='none';
});
</script>
</body>
</html>
