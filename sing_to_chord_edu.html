<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sing to Chord</title>
<style>
  body { margin:0; padding:0; font-family:sans-serif; background:#111; color:#fff; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; }
  button { padding:10px 20px; font-size:16px; margin-bottom:20px; cursor:pointer; }
  #note { font-size:48px; margin-top:20px; transition: color 0.2s ease; }
  #chordFeedback { width:200px; height:200px; margin-top:30px; border-radius:50%; background:#333; display:flex; align-items:center; justify-content:center; font-size:24px; color:#fff; transition: background 0.3s ease, transform 0.3s ease; }
  .switch { position: relative; display: inline-block; width:60px; height:34px; margin-top:20px; }
  .switch input { opacity:0; width:0; height:0; }
  .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background:#ccc; transition:.4s; border-radius:34px; }
  .slider:before { position:absolute; content:""; height:26px; width:26px; left:4px; bottom:4px; background:white; transition:.4s; border-radius:50%; }
  input:checked + .slider { background:#22c55e; }
  input:checked + .slider:before { transform:translateX(26px); }
</style>
</head>
<body>
<button id="startBtn">Start Sing-to-Chord</button>
<div id="note">-</div>
<div id="chordFeedback">â™ª</div>
<label class="switch">
  <input type="checkbox" id="stringGainToggle">
  <span class="slider"></span>
</label>
<script>
const notes = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
let audioContext, analyser, dataArray, source;
let lastFreq = 0;
let freqBuffer = [];
const bufferInterval = 100;

function startTuner(){
  navigator.mediaDevices.getUserMedia({ audio:true }).then(stream=>{
    audioContext = new (window.AudioContext||window.webkitAudioContext)();
    source = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;
    source.connect(analyser);
    dataArray = new Float32Array(analyser.fftSize);
    setInterval(sampleFrequency, bufferInterval);
    update();
  }).catch(err=>alert('Microphone error: '+err));
}

function autoCorrelate(buf, sampleRate) {
  let SIZE = buf.length;
  let rms = 0;
  for (let i = 0; i < SIZE; i++) rms += buf[i]*buf[i];
  rms = Math.sqrt(rms/SIZE);
  if(rms<0.01) return -1;
  let r1=0,r2=SIZE-1,thresh=0.2;
  for(let i=0;i<SIZE/2;i++) if(Math.abs(buf[i])<thresh){r1=i;break;}
  for(let i=1;i<SIZE/2;i++) if(Math.abs(buf[SIZE-i])<thresh){r2=SIZE-i;break;}
  buf = buf.slice(r1,r2);
  SIZE = buf.length;
  let c = new Array(SIZE).fill(0);
  for(let i=0;i<SIZE;i++) for(let j=0;j<SIZE-i;j++) c[i] += buf[j]*buf[j+i];
  let d=0; while(c[d]>c[d+1]) d++;
  let maxval=-1,maxpos=-1;
  for(let i=d;i<SIZE;i++){if(c[i]>maxval){maxval=c[i]; maxpos=i;}}
  let T0 = maxpos;
  return sampleRate/T0;
}

function sampleFrequency(){
  analyser.getFloatTimeDomainData(dataArray);
  let freq = autoCorrelate(dataArray,audioContext.sampleRate);
  if(freq>0){
    freqBuffer.push(freq);
    if(freqBuffer.length > 5) freqBuffer.shift();
  }
}

function getMainFrequency(){
  if(freqBuffer.length===0) return -1;
  let sorted = [...freqBuffer].sort((a,b)=>a-b);
  return sorted[Math.floor(sorted.length/2)];
}

function playChord(freq){
  if(freq<=0) return;
  const gain = audioContext.createGain();
  gain.gain.value = 0.15;
  gain.connect(audioContext.destination);

  const stringGain = document.getElementById('stringGainToggle').checked ? 0.6 : 0.3;

  function createGuitarOsc(noteFreq){
    const osc = audioContext.createOscillator();
    const filter = audioContext.createBiquadFilter();
    const oscGain = audioContext.createGain();
    osc.type = 'sawtooth';
    osc.frequency.value = noteFreq;
    osc.detune.value = (Math.random()-0.5)*10;
    filter.type = 'lowpass';
    filter.frequency.value = 1200;
    filter.Q.value = 1;
    oscGain.gain.setValueAtTime(0, audioContext.currentTime);
    oscGain.gain.linearRampToValueAtTime(stringGain, audioContext.currentTime + 0.03); // pluck attack
    oscGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1); // decay
    osc.connect(filter);
    filter.connect(oscGain);
    oscGain.connect(gain);
    return {osc, oscGain};
  }

  const root = createGuitarOsc(freq);
  const third = createGuitarOsc(freq * Math.pow(2,4/12));
  const fifth = createGuitarOsc(freq * Math.pow(2,7/12));

  [root, third, fifth].forEach(o=>o.osc.start());
  [root, third, fifth].forEach(o=>o.osc.stop(audioContext.currentTime + 1));

  const feedback = document.getElementById('chordFeedback');
  feedback.style.background = '#22c55e';
  feedback.style.transform = 'scale(1.2)';
  setTimeout(()=>{ feedback.style.background='#333'; feedback.style.transform='scale(1)'; }, 300);
}

function update(){
  requestAnimationFrame(update);
  let freq = getMainFrequency();
  if(freq==-1){ document.getElementById('note').innerText='-'; return;}
  freq = lastFreq*0.8 + freq*0.2;
  lastFreq = freq;
  let noteNum = 12*Math.log2(freq/440)+69;
  let noteIndex = Math.round(noteNum)%12;
  document.getElementById('note').innerText = notes[noteIndex];
  playChord(freq);
}

document.getElementById('startBtn').addEventListener('click',()=>{
  startTuner();
  document.getElementById('startBtn').style.display='none';
});
</script>
</body>
</html>
