<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple AI Digit Predictor (Fuzzy Training)</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    canvas { border: 1px solid #ccc; margin: 10px; }
    #settings { margin-top: 15px; }
    .label { font-weight: bold; }
    #trainBtn { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>AI Lite 3</h2>
  <p>Draw a digit (0-9) in the box below, then click Predict.</p>
  <canvas id="canvas" width="100" height="100"></canvas><br>
  <button id="clearBtn">Clear</button>
  <button id="predictBtn">Predict</button>
  <button id="trainBtn">Fuzzy Train (demo)</button>

  <div id="settings"></div>
  <h3>Prediction: <span id="prediction">-</span></h3>

  <script>
    // ==== Activation Functions ====
    function relu(x) { return Math.max(0, x); }
    function dRelu(x) { return x>0 ? 1 : 0; }
    function softmax(arr) {
      const exps = arr.map(Math.exp);
      const sum = exps.reduce((a, b) => a + b, 0);
      return exps.map(v => v / sum);
    }

    // ==== Simple NN ====
    class SimpleNN {
      constructor(inputSize, hiddenSize, outputSize, lr=0.01) {
        this.inputSize = inputSize;
        this.hiddenSize = hiddenSize;
        this.outputSize = outputSize;
        this.lr = lr;
        this.W1 = Array.from({length: hiddenSize}, () => Array.from({length: inputSize}, () => Math.random()*0.2-0.1));
        this.W2 = Array.from({length: outputSize}, () => Array.from({length: hiddenSize}, () => Math.random()*0.2-0.1));
      }

      forward(input) {
        this.input = input;
        this.z1 = this.W1.map(r => r.reduce((s,v,i)=>s+v*input[i],0));
        this.a1 = this.z1.map(relu);
        this.z2 = this.W2.map(r => r.reduce((s,v,i)=>s+v*this.a1[i],0));
        this.a2 = softmax(this.z2);
        return this.a2;
      }

      backward(target) {
        const error = this.a2.map((o,i)=>o-target[i]);
        // dW2
        for (let i=0;i<this.W2.length;i++) {
          for (let j=0;j<this.W2[i].length;j++) {
            this.W2[i][j] -= this.lr * error[i] * this.a1[j];
          }
        }
        // backprop to hidden
        const hiddenErr = this.W2.map((col,i)=>col.reduce((s,w,j)=>s+w*error[j],0));
        for (let i=0;i<this.W1.length;i++) {
          for (let j=0;j<this.W1[i].length;j++) {
            this.W1[i][j] -= this.lr * hiddenErr[i]*dRelu(this.z1[i])*this.input[j];
          }
        }
      }

      train(input, target) {
        this.forward(input);
        this.backward(target);
      }

      predict(input) {
        return this.forward(input);
      }
    }

    // ==== Setup ====
    const inputSize = 100; // 10x10 downsample
    const hiddenSize = 32;
    const outputSize = 10;
    const nn = new SimpleNN(inputSize, hiddenSize, outputSize, 0.01);

    document.getElementById("settings").innerHTML = `
      <div><span class="label">Input size:</span> ${inputSize}</div>
      <div><span class="label">Hidden size:</span> ${hiddenSize}</div>
      <div><span class="label">Output size:</span> ${outputSize}</div>
      <div><span class="label">Learning rate:</span> ${nn.lr}</div>
    `;

    // ==== Canvas Drawing ====
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = "black"; ctx.lineWidth = 8; ctx.lineCap = "round";

    let drawing = false;
    canvas.addEventListener("mousedown", ()=>drawing=true);
    canvas.addEventListener("mouseup", ()=>drawing=false);
    canvas.addEventListener("mousemove", e=>{
      if(!drawing) return;
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX-rect.left, e.clientY-rect.top);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.clientX-rect.left, e.clientY-rect.top);
    });

    document.getElementById("clearBtn").onclick = () => {
      ctx.fillStyle="white"; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.beginPath();
      document.getElementById("prediction").innerText = "-";
    };

    // ==== Helper to get input ====
    function getInputArray() {
      const small = document.createElement("canvas");
      small.width=10; small.height=10;
      small.getContext("2d").drawImage(canvas,0,0,10,10);
      const data = small.getContext("2d").getImageData(0,0,10,10).data;
      let input=[];
      for(let i=0;i<data.length;i+=4){
        input.push((255-data[i])/255); // invert black
      }
      return input;
    }

    // ==== Prediction ====
    document.getElementById("predictBtn").onclick = () => {
      const input = getInputArray();
      const out = nn.predict(input);
      const guess = out.indexOf(Math.max(...out));
      document.getElementById("prediction").innerText = guess;
    };

    // ==== Fuzzy Training ====
    function jitterInput(input, strength=0.1) {
      return input.map(v => {
        let noise = (Math.random()*2-1)*strength;
        return Math.min(1, Math.max(0, v+noise));
      });
    }

    document.getElementById("trainBtn").onclick = () => {
      const input = getInputArray();
      const label = prompt("Enter the digit you just drew (0-9):");
      if(label===null || isNaN(label)) return;
      const target = Array(outputSize).fill(0); target[+label]=1;
      // Do fuzzy augmentation: multiple jittered versions
      for(let i=0;i<20;i++){
        const noisyInput = jitterInput(input, 0.2);
        nn.train(noisyInput, target);
      }
      alert("Fuzzy training done on digit "+label+"!");
    };
  </script>
</body>
</html>
