<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rap Discotech â€” Beat Visualizer</title>
<style>
  :root{--slate:#eeeeee;--panel:#354f52;--accent:#ffd166}
  html,body{height:100%;margin:0;background:var(--slate);font-family:system-ui,Segoe UI,Roboto,Arial;color:#eef}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:20px;padding:20px;align-items:start}
  .panel{background:var(--panel);border-radius:12px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,0.4)}
  h1{margin:0 0 8px 0;font-size:20px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:10px 12px;border-radius:8px;color:inherit;cursor:pointer}
  .controls{display:flex;flex-direction:column;gap:10px}
  label{font-size:13px;opacity:0.9}
  input[type=range]{width:100%}
  .footer{font-size:12px;color:#c9d6df;margin-top:12px}
  .modeRow{display:flex;gap:8px;flex-wrap:wrap}
  .subgenre{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;cursor:pointer}
  .subgenre.active{box-shadow:0 6px 18px rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.06)}
  @media(max-width:880px){.wrap{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <h1>Rap Discotech ðŸŽ§</h1>
    <div class="small">Beat engine with connected visualizer. Adjust tempo, mix, energy, and visual modes.</div>

    <section style="margin-top:12px" class="controls">
      <div>
        <label>Play / Stop</label>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="playBtn" class="btn">Play</button>
          <button id="stopBtn" class="btn">Stop</button>
          <button id="sparkBtn" class="btn">Sparkle</button>
        </div>
      </div>

      <div>
        <label>BPM <span id="bpmVal">95</span></label>
        <input id="bpm" type="range" min="60" max="180" value="95">
      </div>

      <div>
        <label>Kick / Snare Mix</label>
        <input id="mix" type="range" min="0" max="1" step="0.01" value="0.7">
      </div>

      <div>
        <label>Energy</label>
        <input id="energy" type="range" min="0" max="1" step="0.01" value="0.7">
      </div>

      <div>
        <label>Discotech Mode</label>
        <div class="modeRow" style="margin-top:8px">
          <div id="modeCalm" class="subgenre active">Glow</div>
          <div id="modeFlash" class="subgenre">Strobe</div>
          <div id="modeWave" class="subgenre">Wave</div>
        </div>
      </div>

      <div class="footer">Visualizer responds directly to the beat. Sparkle to enhance effects.</div>
    </section>
  </div>

  <div class="panel visual">
    <canvas id="visualCanvas"></canvas>
  </div>
</div>

<script>
let audioCtx = null;
let isPlaying = false;
let beatTimer = null;
let nextNoteTime = 0;
let currentBPM = 95;
const lookahead = 25.0;
const scheduleAheadTime = 0.1;
let kickLevel = 0.8;
let energy = 0.7;
let sparkle = false;
let current16th = 0;
let lastKick = false;

const pattern = {kick:[0,4,8,12], snare:[4,12], hat:[2,6,10,14]};

const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('stopBtn');
const bpmEl = document.getElementById('bpm');
const bpmVal = document.getElementById('bpmVal');
const mixEl = document.getElementById('mix');
const energyEl = document.getElementById('energy');
const sparkBtn = document.getElementById('sparkBtn');
const modeCalm = document.getElementById('modeCalm');
const modeFlash = document.getElementById('modeFlash');
const modeWave = document.getElementById('modeWave');
let visualMode = 'Glow';

// Canvas setup
const canvas = document.getElementById('visualCanvas');
const ctx = canvas.getContext('2d');
let W = 0, H = 0; function resize(){ W=canvas.width=canvas.clientWidth*devicePixelRatio; H=canvas.height=canvas.clientHeight*devicePixelRatio; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
window.addEventListener('resize', resize); resize();

// Particles for visualizer
const particles = [];
for(let i=0;i<150;i++){ particles.push({x:Math.random()*canvas.clientWidth, y:Math.random()*canvas.clientHeight, r:Math.random()*3+1, hue:Math.random()*360, vy:(Math.random()*0.4-0.2)}); }

function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } }

function scheduleKick(time,amp=1){
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type='sine'; o.frequency.setValueAtTime(120,time);
  o.frequency.exponentialRampToValueAtTime(40,time+0.08);
  g.gain.setValueAtTime(amp,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.25);
  o.connect(g); g.connect(audioCtx.destination); o.start(time); o.stop(time+0.3);
  lastKick = true;
}
function scheduleSnare(time,amp=0.5){
  const bufferSize=audioCtx.sampleRate*0.2; const buffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate);
  const data=buffer.getChannelData(0); for(let i=0;i<bufferSize;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(bufferSize*0.03));
  const src=audioCtx.createBufferSource(); src.buffer=buffer;
  const g=audioCtx.createGain(); g.gain.setValueAtTime(amp,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.12);
  src.connect(g); const high=audioCtx.createBiquadFilter(); high.type='highshelf'; high.frequency.value=2000; high.gain.value=6;
  g.connect(high); high.connect(audioCtx.destination); src.start(time); src.stop(time+0.2);
}
function scheduleHat(time,amp=0.12){
  const bufferSize=audioCtx.sampleRate*0.06; const buffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate);
  const data=buffer.getChannelData(0); for(let i=0;i<bufferSize;i++) data[i]=(Math.random()*2-1)*Math.exp(-i/(bufferSize*0.01));
  const src=audioCtx.createBufferSource(); src.buffer=buffer; const g=audioCtx.createGain(); g.gain.setValueAtTime(amp,time); g.gain.exponentialRampToValueAtTime(0.001,time+0.06);
  src.connect(g); const hf=audioCtx.createBiquadFilter(); hf.type='highpass'; hf.frequency.value=8000;
  g.connect(hf); hf.connect(audioCtx.destination); src.start(time); src.stop(time+0.07);
}

function nextNote(){ const secondsPerBeat=60.0/currentBPM; nextNoteTime+=0.25*secondsPerBeat; current16th=(current16th+1)%16; lastKick=false; }
function scheduler(){ while(nextNoteTime<audioCtx.currentTime+scheduleAheadTime){ if(pattern.kick.includes(current16th)) scheduleKick(nextNoteTime, kickLevel*(0.7+energy*0.6));
if(pattern.snare.includes(current16th)) scheduleSnare(nextNoteTime,0.6*(0.6+energy*0.6)); if(pattern.hat.includes(current16th)) scheduleHat(nextNoteTime,0.12*(0.6+energy*0.8)); nextNote(); } }

function startBeat(){ ensureAudio(); if(audioCtx.state==='suspended') audioCtx.resume(); current16th=0; nextNoteTime=audioCtx.currentTime+0.05; if(beatTimer) clearInterval(beatTimer); beatTimer=setInterval(scheduler,lookahead); isPlaying=true; }
function stopBeat(){ if(beatTimer){ clearInterval(beatTimer); beatTimer=null; } isPlaying=false; }

// UI events
playBtn.onclick = ()=>startBeat();
stopBtn.onclick = ()=>stopBeat();
bpmEl.oninput=()=>{ currentBPM=parseInt(bpmEl.value); bpmVal.textContent=currentBPM; };
mixEl.oninput=()=>{ kickLevel=parseFloat(mixEl.value); };
energyEl.oninput=()=>{ energy=parseFloat(energyEl.value); };
sparkBtn.onclick=()=>{ sparkle=!sparkle; sparkBtn.textContent = sparkle?'Sparkling':'Sparkle'; };
[modeCalm,modeFlash,modeWave].forEach(el=>el.onclick=()=>{visualMode=el.textContent;[modeCalm,modeFlash,modeWave].forEach(x=>x.classList.remove('active'));el.classList.add('active');});

// Visualizer draws particles and connects pulses to beat
function drawVisual(){
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
  ctx.fillStyle='rgba(47,62,70,0.25)'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);

  particles.forEach(p=>{
    p.y += p.vy*(1+energy*2);
    if(p.y<-10)p.y=canvas.clientHeight+10; if(p.y>canvas.clientHeight+10)p.y=-10;
    let alpha = 0.6;
    if(visualMode==='Strobe'){ alpha = (Math.random()>0.85? 1 : 0.15); }
    else if(visualMode==='Wave'){ alpha = 0.5+0.5*Math.sin((p.x/200)+performance.now()/600); }
    if(lastKick){ alpha += 0.3*Math.random(); p.r += energy*2; } else { p.r = Math.random()*3+1; }
    ctx.beginPath();
    const hue = (p.hue + (sparkle? Math.random()*40:0) + (energy*80))%360;
    ctx.fillStyle=`hsla(${hue},80%,60%,${alpha})`;
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
  });

  if(isPlaying){ const t=performance.now()/1000; const pulse=0.6+0.4*Math.sin(t*(currentBPM/60)*Math.PI);
  ctx.beginPath(); ctx.strokeStyle=`rgba(255,209,102,${0.06+0.05*pulse})`; ctx.lineWidth=6;
  ctx.arc(canvas.clientWidth/2,canvas.clientHeight/2,80+40*pulse,0,Math.PI*2); ctx.stroke(); }

  requestAnimationFrame(drawVisual);
}
requestAnimationFrame(drawVisual);
</script>
</body>
</html>
