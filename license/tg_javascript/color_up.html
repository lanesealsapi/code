<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Speech to Particles</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: black;
    font-family: system-ui, sans-serif;
    color: white;
  }
  #commands {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(30,30,30,0.7);
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.5;
  }
  #commands h3 {
    margin-top: 0;
    font-size: 16px;
  }
  #debug {
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
    background: rgba(20, 20, 20, 0.7);
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 14px;
    color: #0f0;
    font-family: monospace;
  }
  canvas {
    display: block;
  }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<div id="commands">
  <h3>ðŸŽ¤ Speech Commands:</h3>
  <strong>Colors:</strong><br>
  red, orange, yellow, green, blue, indigo, violet<br><br>
  <strong>Move:</strong><br>
  left, right, up, down<br><br>
  <em>Say a color or direction aloud!</em>
</div>

<div id="debug">Listening...</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth;
let H = canvas.height = window.innerHeight;

window.addEventListener('resize', () => {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
});

class Particle {
  constructor(x, y, color) {
    this.x = x;
    this.y = y;
    this.color = color;
    this.vx = (Math.random() - 0.5) * 2;
    this.vy = (Math.random() - 0.5) * 2;
    this.size = Math.random() * 2 + 1;
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    if (this.x < 0 || this.x > W) this.vx *= -1;
    if (this.y < 0 || this.y > H) this.vy *= -1;
  }
  draw() {
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fillStyle = this.color;
    ctx.fill();
  }
}

const particles = [];
let currentColor = 'white';
for (let i = 0; i < 200; i++) {
  particles.push(new Particle(Math.random() * W, Math.random() * H, currentColor));
}

function animate() {
  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.fillRect(0, 0, W, H);
  for (let p of particles) {
    p.update();
    p.draw();
  }
  requestAnimationFrame(animate);
}
animate();

function moveParticles(dx, dy) {
  for (let p of particles) {
    p.x += dx;
    p.y += dy;
  }
}

function changeColor(color) {
  for (let p of particles) p.color = color;
}

function startRecognition() {
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!window.SpeechRecognition) {
    alert("Speech Recognition not supported in this browser. Try Chrome.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  const debugEl = document.getElementById('debug');

  recognition.onresult = (event) => {
    let interim = '';
    let finalText = '';

    for (let i = event.resultIndex; i < event.results.length; ++i) {
      const transcript = event.results[i][0].transcript.toLowerCase();
      if (event.results[i].isFinal) {
        finalText += transcript + ' ';
        processCommand(transcript);
      } else {
        interim += transcript;
      }
    }

    debugEl.textContent = finalText || interim || 'Listening...';
  };

  recognition.onerror = (e) => {
    console.error(e);
    debugEl.textContent = 'Error: ' + e.error;
  };

  recognition.onend = () => recognition.start(); // Restart if ended
  recognition.start();
}

function processCommand(text) {
  // regex with word boundaries to catch variations like "go left"
  const match = (word) => new RegExp("\\b" + word + "\\b").test(text);

  if (match('red')) changeColor('red');
  else if (match('orange')) changeColor('orange');
  else if (match('yellow')) changeColor('yellow');
  else if (match('green')) changeColor('green');
  else if (match('blue')) changeColor('blue');
  else if (match('indigo')) changeColor('indigo');
  else if (match('violet')) changeColor('violet');

  const step = 100;
  if (match('left')) moveParticles(-step, 0);
  else if (match('right')) moveParticles(step, 0);
  else if (match('up')) moveParticles(0, -step);
  else if (match('down')) moveParticles(0, step);
}

// Ask for microphone once on load
window.addEventListener('load', () => {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("Microphone access not supported in this browser.");
    return;
  }

  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      stream.getTracks().forEach(t => t.stop());
      startRecognition();
    })
    .catch(() => {
      alert("Microphone permission denied. Please allow it and reload.");
    });
});
</script>
</body>
</html>
