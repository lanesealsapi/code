<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Epic Elemental Breathing</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: black;
    font-family: sans-serif;
    color: white;
  }
  #canvas {
    display: block;
  }
  #controls {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 10;
  }
  button {
    padding: 10px 20px;
    margin-right: 10px;
    cursor: pointer;
    font-size: 16px;
    background: rgba(255,255,255,0.1);
    border: 1px solid white;
    color: white;
    border-radius: 6px;
    transition: 0.2s;
  }
  button:hover {
    background: rgba(255,255,255,0.3);
  }
</style>
</head>
<body>
<div id="controls">
  <button id="fireBtn">Fire</button>
  <button id="waterBtn">Water</button>
</div>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let element = 'fire';
document.getElementById('fireBtn').onclick = () => element = 'fire';
document.getElementById('waterBtn').onclick = () => element = 'water';

const particles = [];

class Particle {
  constructor(x, y, dx, dy, color, size, life) {
    this.x = x;
    this.y = y;
    this.dx = dx;
    this.dy = dy;
    this.color = color;
    this.size = size;
    this.life = life;
    this.opacity = 1;
  }
  update() {
    this.x += this.dx;
    this.y += this.dy;
    this.life -= 1;
    this.opacity = this.life / 100;
    if(element === 'fire') this.dy -= 0.08 + Math.random()*0.05;
    else this.dy += 0.05 + Math.random()*0.03;
    this.dx += (Math.random()-0.5)*0.1; // chaotic drift
  }
  draw() {
    ctx.fillStyle = this.color.replace('OPACITY', this.opacity);
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
  }
}

function addParticles(volume) {
  const count = Math.floor(volume * 20); // more particles for epic effect
  for(let i = 0; i < count; i++){
    const x = canvas.width/2 + (Math.random() - 0.5) * 80;
    const y = canvas.height/2 + (Math.random() - 0.5) * 80;
    const dx = (Math.random() - 0.5) * 3;
    const dy = (Math.random() - 0.5) * 3;
    let color, size;
    if(element === 'fire'){
      color = `rgba(255,${Math.floor(Math.random()*200)},0,OPACITY)`;
      size = Math.random() * 10 + 2;
    } else {
      color = `rgba(0,${Math.floor(Math.random()*200)+50},255,OPACITY)`;
      size = Math.random() * 8 + 2;
    }
    particles.push(new Particle(x, y, dx, dy, color, size, 100));
  }
}

function animate() {
  // add a soft trail effect
  ctx.fillStyle = 'rgba(0,0,0,0.15)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  for(let i = particles.length - 1; i >= 0; i--){
    const p = particles[i];
    p.update();
    p.draw();
    if(p.life <= 0) particles.splice(i, 1);
  }
  requestAnimationFrame(animate);
}

// Microphone setup
navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const source = audioCtx.createMediaStreamSource(stream);
  const analyser = audioCtx.createAnalyser();
  source.connect(analyser);
  analyser.fftSize = 256;
  const dataArray = new Uint8Array(analyser.frequencyBinCount);

  function getVolume() {
    analyser.getByteTimeDomainData(dataArray);
    let sum = 0;
    for(let i = 0; i < dataArray.length; i++){
      let v = dataArray[i] - 128;
      sum += v*v;
    }
    return Math.min(sum / dataArray.length / 500, 1); // normalized
  }

  function update() {
    const volume = getVolume();
    if(volume > 0.02) addParticles(volume);
    requestAnimationFrame(update);
  }

  update();
}).catch(err => {
  alert("Microphone access required to use elemental breathing!");
});

animate();
</script>
</body>
</html>
