<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Musical Chaos Dolphin</title>
<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background: linear-gradient(135deg, #89f7fe, #66a6ff);
    font-family: sans-serif;
    user-select: none;
  }
  #emoji {
    font-size: 100px;
    cursor: pointer;
    transition: transform 0.2s;
  }
  #response {
    margin-top: 20px;
    font-size: 28px;
    text-align: center;
    max-width: 500px;
    font-family: monospace;
  }
  #pokeBtn {
    margin-top: 20px;
    font-size: 18px;
    padding: 10px 20px;
    cursor: pointer;
  }
  #mood {
    margin-top: 10px;
    font-size: 18px;
    font-style: italic;
  }
</style>
</head>
<body>

<div id="emoji">üê¨</div>
<div id="response">Tap the dolphin to hear its song...</div>
<button id="pokeBtn">I liked that whistle!</button>
<div id="mood">Mood: Calm</div>

<script>
const baseWhistles = [
  "~‚ô™~", "‚ô™~‚ô™", "üí®~", "~üí®", "üîä~‚ô™", "üê¨‚ô™", "‚ô™‚ô™‚ô™", "~‚ô™üí®", "üí®‚ô™~", "~üê¨~",
  "‚ô™~üê¨", "üîä‚ô™~", "~‚ô™‚ô™", "üê¨üí®~", "üí®üí®‚ô™", "~‚ô™‚ô™‚ô™", "‚ô™üê¨~", "~üîä~", "‚ô™üí®~", "üí®‚ô™üê¨"
];

// map each "whistle" to a simple melody (array of frequencies in Hz)
const whistleMelodies = {};
baseWhistles.forEach(w => {
  let notes = [];
  for(let i=0;i<w.length;i++){
    let base = 600 + Math.random()*300;
    notes.push(base);
  }
  whistleMelodies[w] = notes;
});

let whistleScores = {};
baseWhistles.forEach(p => whistleScores[p] = 1);

let history = [];
let lastClick = Date.now();
let mood = "Calm";

const emojiEl = document.getElementById("emoji");
const responseEl = document.getElementById("response");
const pokeBtn = document.getElementById("pokeBtn");
const moodEl = document.getElementById("mood");

// Web Audio setup
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playMelody(notes, duration = 0.2){
  let time = audioCtx.currentTime;
  notes.forEach((freq, i)=>{
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";
    osc.frequency.setValueAtTime(freq, time);
    gain.gain.setValueAtTime(0, time);
    gain.gain.linearRampToValueAtTime(0.2, time + 0.05);
    gain.gain.linearRampToValueAtTime(0, time + duration);

    osc.connect(gain).connect(audioCtx.destination);
    osc.start(time);
    osc.stop(time + duration);
    time += duration;
  });
}

function weightedRandom(arr, scores) {
  const sum = arr.reduce((acc, p) => acc + scores[p], 0);
  let r = Math.random() * sum;
  for (let p of arr) {
    if (r < scores[p]) return p;
    r -= scores[p];
  }
  return arr[arr.length - 1];
}

function mutateWhistle(whistle) {
  if(Math.random() < 0.3){
    const symbols = ["~","‚ô™","üí®","üê¨","üîä"];
    const arr = whistle.split("");
    const idx = Math.floor(Math.random()*arr.length);
    arr[idx] = symbols[Math.floor(Math.random()*symbols.length)];
    // also mutate melody slightly
    let melody = whistleMelodies[whistle].map(f => f + (Math.random()*60 - 30));
    whistleMelodies[arr.join("")] = melody;
    return arr.join("");
  }
  return whistle;
}

function updateMood() {
  const now = Date.now();
  const delta = now - lastClick;
  if(delta < 500) mood = "Mischievous üòè";
  else if(delta > 2000) mood = "Sleepy üò¥";
  else mood = "Happy üòÑ";
  moodEl.textContent = "Mood: " + mood;
  lastClick = now;
}

function chaosWhistle() {
  updateMood();
  let available = baseWhistles.filter(p => !history.slice(-3).includes(p));
  let choice = weightedRandom(available, whistleScores);

  choice = mutateWhistle(choice);
  history.push(choice);

  // wobble based on mood
  let rotate = (Math.random()-0.5)*30;
  let scale = 1 + Math.random()*0.2;
  if(mood.includes("Mischievous")) rotate *= 2;
  if(mood.includes("Sleepy")) rotate *= 0.3, scale *= 0.9;
  emojiEl.style.transform = `rotate(${rotate}deg) scale(${scale})`;

  responseEl.textContent = choice;

  // play the multi-note whistle
  let notes = whistleMelodies[choice] || [700,800,750];
  if(mood.includes("Mischievous")) notes = notes.map(n=>n+100);
  if(mood.includes("Sleepy")) notes = notes.map(n=>n-150);
  playMelody(notes, 0.2);
}

function rewardCurrent() {
  const last = history[history.length-1];
  if(last) whistleScores[last] += 2;
}

emojiEl.addEventListener("click", chaosWhistle);
pokeBtn.addEventListener("click", rewardCurrent);

</script>

</body>
</html>
