<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laser Tag</title>
<style>
body { margin:0; overflow:hidden; background:#111; font-family:sans-serif; }
#score,#lives{position:absolute;top:10px;font-size:24px;text-shadow:0 0 10px #0ff;color:#0ff;}
#score{left:10px;}#lives{right:10px;}
canvas{display:block;}
</style>
</head>
<body>
<div id="score">Score: 0</div>
<div id="lives">Lives: 3</div>
<canvas id="gameCanvas"></canvas>
<script>
const canvas=document.getElementById('gameCanvas'), ctx=canvas.getContext('2d');
canvas.width=window.innerWidth; canvas.height=window.innerHeight;
window.addEventListener('resize',()=>{canvas.width=window.innerWidth; canvas.height=window.innerHeight;});

// =======================
// Audio Controller
// =======================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const Audio = {
    laser: { type:'triangle', baseFreq:900, endFreq:400, duration:0.15, gain:0.15 },
    boom: { type:'triangle', baseFreq:120, duration:0.3, gain:0.3 },
    playLaser: function() {
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type=this.laser.type;
        o.frequency.setValueAtTime(this.laser.baseFreq, audioCtx.currentTime);
        o.frequency.exponentialRampToValueAtTime(this.laser.endFreq, audioCtx.currentTime+this.laser.duration);
        g.gain.setValueAtTime(this.laser.gain, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+this.laser.duration);
        o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+this.laser.duration);
    },
    playBoom: function() {
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type=this.boom.type;
        o.frequency.setValueAtTime(this.boom.baseFreq, audioCtx.currentTime);
        g.gain.setValueAtTime(this.boom.gain, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+this.boom.duration);
        o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+this.boom.duration);
    }
};

// =======================
// Game Variables
// =======================
const player={x:canvas.width/2,y:canvas.height/2,size:20,speed:5,color:'#0ff',lives:3};
let keys={},lasers=[],enemies=[],powerUps=[],explosions=[],shockwaves=[],score=0,rapidFire=false,lastShot=0,gameTime=0,laserCount=0;
let mouse={x:player.x,y:player.y};

const enemyTypes=[{size:15,speed:1.5,color:'#f0f'},{size:20,speed:1,color:'#f0f'},{size:25,speed:0.7,color:'#ff0'}];
function spawnEnemy(){const t=enemyTypes[Math.floor(Math.random()*enemyTypes.length)];
enemies.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,size:t.size,color:t.color,vx:(Math.random()-0.5)*t.speed*2,vy:(Math.random()-0.5)*t.speed*2,speed:t.speed,stunned:false,stunTimer:0});}
for(let i=0;i<5;i++) spawnEnemy();

// =======================
// Input
// =======================
document.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
document.addEventListener('mousemove',e=>mouse={x:e.clientX,y:e.clientY});
document.addEventListener('click',shootLaser);

function shootLaser(){
    const now=Date.now(); if(!rapidFire && now-lastShot<300) return; lastShot=now;
    laserCount++;
    const dx=mouse.x-player.x, dy=mouse.y-player.y, len=Math.sqrt(dx*dx+dy*dy), speed=10;
    lasers.push({x:player.x,y:player.y,size:5,color:'#00f',vx:dx/len*speed,vy:dy/len*speed,trail:[]});
    Audio.playLaser();

    if(laserCount%3===0){
        Audio.playBoom();
        shockwaves.push({x:player.x,y:player.y,radius:0,alpha:1});
        enemies.forEach(e=>{
            const dist=Math.hypot(player.x-e.x,player.y-e.y);
            if(dist<200){ e.stunned=true; e.stunTimer=60; }
        });
    }
}

// Power-ups
function spawnPowerUp(){powerUps.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,size:15,type:Math.random()<0.5?'speed':'rapid',color:'#0f0'});}
setInterval(spawnPowerUp,10000);
function createExplosion(x,y,color){explosions.push({x,y,radius:0,alpha:1,color});}

// =======================
// Update Loop
// =======================
function update(){
    gameTime+=1/60;
    if(Math.floor(gameTime)%15===0 && enemies.length<10+Math.floor(gameTime/15)) spawnEnemy();

    // Player movement
    if(keys['w']||keys['arrowup'])player.y-=player.speed;
    if(keys['s']||keys['arrowdown'])player.y+=player.speed;
    if(keys['a']||keys['arrowleft'])player.x-=player.speed;
    if(keys['d']||keys['arrowright'])player.x+=player.speed;
    player.x=Math.max(player.size,Math.min(canvas.width-player.size,player.x));
    player.y=Math.max(player.size,Math.min(canvas.height-player.size,player.y));

    // Lasers
    lasers.forEach(l=>{l.trail.push({x:l.x,y:l.y}); if(l.trail.length>5) l.trail.shift(); l.x+=l.vx; l.y+=l.vy;});
    lasers=lasers.filter(l=>l.x>0&&l.x<canvas.width&&l.y>0&&l.y<canvas.height);

    // Enemies
    enemies.forEach(e=>{
        if(!e.stunned){
            // 50% chance to stray randomly
            if(Math.random()<0.5){ e.x += (Math.random()-0.5)*2*e.speed; e.y += (Math.random()-0.5)*2*e.speed; }
            else {
                const dx = player.x - e.x, dy = player.y - e.y, dist = Math.sqrt(dx*dx+dy*dy);
                e.x += (dx/dist)*e.speed; e.y += (dy/dist)*e.speed;
            }
        } else { e.stunTimer--; if(e.stunTimer<=0) e.stunned=false; }

        // Keep in bounds
        e.x=Math.max(e.size,Math.min(canvas.width-e.size,e.x));
        e.y=Math.max(e.size,Math.min(canvas.height-e.size,e.y));

        // Player collision
        if(Math.hypot(player.x-e.x,player.y-e.y)<player.size+e.size){
            player.lives--; document.getElementById('lives').innerText='Lives: '+player.lives;
            e.x=Math.random()*canvas.width; e.y=Math.random()*canvas.height;
            if(player.lives<=0){alert('Game Over! Score: '+score); player.lives=3; score=0; gameTime=0; document.getElementById('score').innerText='Score: 0'; document.getElementById('lives').innerText='Lives: 3'; enemies=[]; for(let i=0;i<5;i++) spawnEnemy();}
        }
    });

    // Laser collisions
    lasers.forEach((l,li)=>{enemies.forEach((e,ei)=>{if(Math.hypot(l.x-e.x,l.y-e.y)<l.size+e.size){createExplosion(e.x,e.y,e.color); enemies.splice(ei,1); spawnEnemy(); lasers.splice(li,1); score+=10; document.getElementById('score').innerText='Score: '+score;}});});

    // Power-ups
    powerUps.forEach((p,pi)=>{if(Math.hypot(player.x-p.x,player.y-p.y)<player.size+p.size){if(p.type==='speed'){player.speed+=2; setTimeout(()=>player.speed-=2,5000);} if(p.type==='rapid'){rapidFire=true; setTimeout(()=>rapidFire=false,5000);} powerUps.splice(pi,1);}});

    // Explosions
    explosions.forEach((ex,i)=>{ex.radius+=2; ex.alpha-=0.05; if(ex.alpha<=0) explosions.splice(i,1);});

    // Shockwaves
    shockwaves.forEach((s,i)=>{s.radius+=10; s.alpha-=0.03; if(s.alpha<=0) shockwaves.splice(i,1);});

    draw(); requestAnimationFrame(update);
}

// =======================
// Draw Loop
// =======================
function draw(){
    ctx.fillStyle='rgba(17,17,17,0.6)'; ctx.fillRect(0,0,canvas.width,canvas.height);

    // Grid
    ctx.strokeStyle='#222'; for(let x=0;x<canvas.width;x+=50){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
    for(let y=0;y<canvas.height;y+=50){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}

    // Player
    ctx.fillStyle=player.color; ctx.beginPath(); ctx.arc(player.x,player.y,player.size,0,Math.PI*2); ctx.fill();

    // Lasers
    lasers.forEach(l=>{
        for(let i=0;i<l.trail.length;i++){
            const alpha=(i+1)/l.trail.length;
            ctx.fillStyle=`rgba(0,0,255,${alpha})`;
            ctx.beginPath(); ctx.arc(l.trail[i].x,l.trail[i].y,l.size/2,0,Math.PI*2); ctx.fill();
            ctx.fillRect(l.trail[i].x-1,l.trail[i].y+2,2,4);
            ctx.fillRect(l.trail[i].x-2,l.trail[i].y+3,2,3);
        }
    });

    // Enemies
    enemies.forEach(e=>{ctx.fillStyle=e.color; ctx.beginPath(); ctx.arc(e.x,e.y,e.size,0,Math.PI*2); ctx.fill();});

    // Power-ups
    powerUps.forEach(p=>{ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();});

    // Explosions
    explosions.forEach(ex=>{ctx.fillStyle=`rgba(${hexToRgb(ex.color)},${ex.alpha})`; ctx.beginPath(); ctx.arc(ex.x,ex.y,ex.radius,0,Math.PI*2); ctx.fill();});

    // Shockwaves
    shockwaves.forEach(s=>{ctx.strokeStyle=`rgba(0,255,255,${s.alpha})`; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(s.x,s.y,s.radius,0,Math.PI*2); ctx.stroke();});
}

// Helper
function hexToRgb(hex){hex=hex.replace('#',''); const i=parseInt(hex,16); return ((i>>16)&255)+','+((i>>8)&255)+','+(i&255);}

update();
</script>
</body>
</html>
