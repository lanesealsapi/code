<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Butterfly Swarm with Regional Chords</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #2b2b2b; /* dark slate grey */
    height: 100%;
    width: 100%;
    cursor: crosshair;
  }
  canvas { display: block; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let width = canvas.width = window.innerWidth;
let height = canvas.height = window.innerHeight;
window.addEventListener('resize', ()=>{ width=canvas.width=window.innerWidth; height=canvas.height=window.innerHeight; });

const sigma = 10, rho = 28, beta = 8/3;
const dt = 0.01;

class Particle {
  constructor(x,y,color){
    this.x=x; this.y=y; this.z=Math.random()*30;
    this.prevX=x; this.prevY=y; this.color=color;
    this.vx=Math.random()*0.1; this.vy=Math.random()*0.1; this.vz=Math.random()*0.1;
    this.size=Math.random()*10.5+0.5; this.glowIntensity=Math.random()*20+10;
  }
  getVelocityMagnitude(){ return Math.sqrt(this.vx*this.vx + this.vy*this.vy + this.vz*this.vz); }
  update(){
    const dx=sigma*(this.y-this.x)*dt;
    const dy=(this.x*(rho-this.z)-this.y)*dt;
    const dz=(this.x*this.y - beta*this.z)*dt;
    this.vx+=dx; this.vy+=dy; this.vz+=dz;
    this.prevX=this.x; this.prevY=this.y;
    this.x+=this.vx; this.y+=this.vy;
    this.glowIntensity=10 + 10*Math.sin(Date.now()*0.005 + this.x + this.y);
  }
  draw(ctx){
    ctx.strokeStyle=this.color;
    ctx.shadowColor=this.color;
    ctx.shadowBlur=this.glowIntensity;
    ctx.lineWidth=this.size;
    ctx.beginPath();
    ctx.moveTo(this.prevX+width/2,this.prevY+height/2);
    ctx.lineTo(this.x+width/2,this.y+height/2);
    ctx.stroke();
  }
}

let particles=[];

function getChordFromPosition(x,y){
  const baseFreq = 55 + (1 - y/height) * 440; // lower y = higher freq
  const maxNotes = 7;
  const chordNotes = Math.floor(2 + (x/width)*(maxNotes-2)); // left=2, right=7
  const intervals = [0,2,4,5,7,9,11].slice(0,chordNotes); // scale degrees
  return { baseFreq, intervals };
}

function getParticleColor(x, chordNotes){
  const hue = Math.floor(240 - (chordNotes/7)*180); // 2-note=blue, 7-note=red
  const lightness = 60 + Math.random()*20;
  return `hsl(${hue}, 100%, ${lightness}%)`;
}

// Web Audio
const AudioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playChordFromClick(x,y){
  const {baseFreq, intervals} = getChordFromPosition(x,y);
  const duration = 1;
  const startTime = AudioCtx.currentTime;
  const oscillators = [];
  const gains = [];

  intervals.forEach(interval=>{
    const osc = AudioCtx.createOscillator();
    osc.type='triangle';
    osc.frequency.value = baseFreq * Math.pow(2,interval/12);
    const gain = AudioCtx.createGain();
    gain.gain.setValueAtTime(0, startTime);
    osc.connect(gain); gain.connect(AudioCtx.destination);
    osc.start(startTime); osc.stop(startTime + duration);
    oscillators.push(osc); gains.push(gain);
  });

  function updateChord(){
    const totalVelocity = particles.reduce((sum,p)=>sum+p.getVelocityMagnitude(),0);
    const avgVel = totalVelocity/(particles.length||1);
    const scale = Math.min(avgVel*0.05,0.15);

    gains.forEach(g=>{
      g.gain.setTargetAtTime(scale, AudioCtx.currentTime, 0.05);
      g.gain.setTargetAtTime(0, startTime+duration,0.05);
    });

    oscillators.forEach((osc,i)=>{
      const mod = Math.sin(Date.now()*0.001 + i)*avgVel*0.2;
      osc.frequency.setTargetAtTime(osc.frequency.value*(1 + mod*0.005), AudioCtx.currentTime,0.05);
    });

    if(AudioCtx.currentTime < startTime+duration) requestAnimationFrame(updateChord);
  }

  updateChord();
}

canvas.addEventListener('click', e=>{
  const {intervals} = getChordFromPosition(e.clientX,e.clientY);
  const color = getParticleColor(e.clientX, intervals.length);
  for(let i=0;i<60;i++){
    particles.push(new Particle((Math.random()-0.5)*10,(Math.random()-0.5)*10,color));
  }
  //playChordFromClick(e.clientX,e.clientY);
});

function animate(){
  ctx.fillStyle='rgba(43,43,43,1.0)'; // dark slate grey bg
  ctx.fillRect(0,0,width,height);
  for(const p of particles){ p.update(); p.draw(ctx); }
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
